name: Manual V2Ray Collection Run

on:
  workflow_dispatch:
    inputs:
      collection_type:
        description: 'Ù†ÙˆØ¹ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - telegram_only
        - test_only
      max_sources:
        description: 'Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ù…Ù†Ø§Ø¨Ø¹ (0 = Ù‡Ù…Ù‡)'
        required: false
        default: '0'
        type: string
      timeout_minutes:
        description: 'Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± (Ø¯Ù‚ÛŒÙ‚Ù‡)'
        required: false
        default: '60'
        type: string

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write

concurrency:
  group: manual-v2ray-collection
  cancel-in-progress: false

jobs:
  manual-collect:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJson(github.event.inputs.timeout_minutes) || 60 }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ”§ Configure collection
      run: |
        echo "Collection Type: ${{ github.event.inputs.collection_type }}"
        echo "Max Sources: ${{ github.event.inputs.max_sources }}"
        echo "Timeout: ${{ github.event.inputs.timeout_minutes }} minutes"
        
        # ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
        echo "COLLECTION_TYPE=${{ github.event.inputs.collection_type }}" >> $GITHUB_ENV
        echo "MAX_SOURCES=${{ github.event.inputs.max_sources }}" >> $GITHUB_ENV
    
    - name: ğŸ§ª Run tests (if test_only)
      if: github.event.inputs.collection_type == 'test_only'
      run: |
        echo "ğŸ§ª Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øªâ€ŒÙ‡Ø§..."
        python run_tests.py
    
    - name: ğŸ“± Run Telegram collection (if telegram_only)
      if: github.event.inputs.collection_type == 'telegram_only'
      run: |
        echo "ğŸ“± Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù…..."
        python -c "
        import asyncio
        from telegram_collector import TelegramCollector, TELEGRAM_SOURCES
        
        async def main():
            collector = TelegramCollector()
            
            # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹
            for source in TELEGRAM_SOURCES:
                collector.add_source(source)
            
            print(f'ğŸ“Š {len(collector.sources)} Ù…Ù†Ø¨Ø¹ ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯')
            
            # Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ (Ø¨Ø¯ÙˆÙ† bot token)
            if collector.bot_token:
                configs = await collector.collect_all_sources()
                print(f'âœ… {len(configs)} Ú©Ø§Ù†ÙÛŒÚ¯ Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù… Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø´Ø¯')
            else:
                print('âš ï¸ Bot Token ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ - ØªØ³Øª Ø¨Ø¯ÙˆÙ† Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ')
        
        asyncio.run(main())
        "
    
    - name: ğŸš€ Run full collection cycle
      if: github.event.inputs.collection_type == 'full'
      run: |
        echo "ğŸš€ Ø§Ø¬Ø±Ø§ÛŒ Collection Cycle Ú©Ø§Ù…Ù„..."
        python run_collection.py
    
    - name: ğŸ“Š Generate summary
      if: always()
      run: |
        echo "## ğŸ“Š Manual Collection Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Collection Type:** ${{ github.event.inputs.collection_type }}" >> $GITHUB_STEP_SUMMARY
        echo "**Max Sources:** ${{ github.event.inputs.max_sources }}" >> $GITHUB_STEP_SUMMARY
        echo "**Timeout:** ${{ github.event.inputs.timeout_minutes }} minutes" >> $GITHUB_STEP_SUMMARY
        echo "**Run Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "subscriptions/latest_report.json" ]; then
          echo "### ğŸ“ˆ Collection Results:" >> $GITHUB_STEP_SUMMARY
          
          TOTAL=$(jq -r '.total_configs_tested // 0' subscriptions/latest_report.json)
          WORKING=$(jq -r '.working_configs // 0' subscriptions/latest_report.json)
          FAILED=$(jq -r '.failed_configs // 0' subscriptions/latest_report.json)
          SUCCESS_RATE=$(jq -r '.success_rate // "0%"' subscriptions/latest_report.json)
          
          echo "- ğŸ“Š Total configs tested: **$TOTAL**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Working configs: **$WORKING**" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed configs: **$FAILED**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ Success rate: **$SUCCESS_RATE**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ø¢Ù…Ø§Ø± AI Quality
          AI_SCORE=$(jq -r '.ai_quality.average_score // 0' subscriptions/latest_report.json)
          if [ "$AI_SCORE" != "0" ]; then
            echo "### ğŸ¤– AI Quality Metrics:" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ“Š Average AI Score: **$AI_SCORE**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Ø¢Ù…Ø§Ø± Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§
          echo "### ğŸ”Œ Configs by Protocol:" >> $GITHUB_STEP_SUMMARY
          jq -r '.protocols | to_entries[] | "- **\(.key)**: \(.value.count) configs (\(.value.avg_latency))"' subscriptions/latest_report.json >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ø¢Ù…Ø§Ø± Ú©Ø´ÙˆØ±Ù‡Ø§
          echo "### ğŸŒ Top Countries:" >> $GITHUB_STEP_SUMMARY
          jq -r '.countries | to_entries | sort_by(.value.count) | reverse | .[:10] | .[] | "- **\(.key)**: \(.value.count) configs (\(.value.avg_latency))"' subscriptions/latest_report.json >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No report generated" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ“ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: manual-collection-${{ github.run_number }}
        path: |
          subscriptions/*.txt
          subscriptions/*.json
          subscriptions/*.html
        retention-days: 30
    
    - name: ğŸ”„ Commit and push changes
      if: github.event.inputs.collection_type == 'full'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add subscriptions/
        
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        TOTAL_CONFIGS=$(cat subscriptions/all_subscription.txt 2>/dev/null | wc -l || echo "0")
        
        git commit -m "ğŸ¤– Manual collection: ${{ github.event.inputs.collection_type }} - $(date '+%Y-%m-%d %H:%M')

        ğŸ“Š Total configs: $TOTAL_CONFIGS
        ğŸ¯ Collection type: ${{ github.event.inputs.collection_type }}
        â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        ğŸ”„ Run: #${{ github.run_number }}"
        
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
        for i in {1..3}; do
          if git push origin main; then
            echo "âœ… Push successful"
            exit 0
          else
            echo "âš ï¸ Push failed, attempt $i/3"
            git fetch origin main
            git rebase origin/main || git rebase --abort
            sleep 5
          fi
        done
        
        echo "âŒ Push failed after 3 attempts"
        exit 1
    
    - name: ğŸ‰ Success notification
      if: success()
      run: |
        echo "âœ… Manual collection completed successfully!"
        echo "ğŸ“Š Check the summary above for details."
        echo "ğŸ”— View results at: https://ahmadakd.github.io/Onix-V2Ray-Collector/"
