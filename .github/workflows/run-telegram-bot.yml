name: Run Telegram Bot with Polling

on:
  workflow_dispatch:
  schedule:
    # Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†Ø¯
    - cron: '*/10 * * * *'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: telegram-bot-polling
  cancel-in-progress: false

jobs:
  run-telegram-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ”§ Configure environment
      run: |
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> $GITHUB_ENV
        echo "TELEGRAM_ADMIN_USERS=6563143907" >> $GITHUB_ENV
    
    - name: ðŸ¤– Test Bot Connection
      run: |
        echo "ðŸ¤– Testing bot connection..."
        python test_telegram_bot_simple.py
    
    - name: ðŸ“± Run Telegram Config Collector
      run: |
        echo "ðŸ“± Starting Telegram Config Collector..."
        python telegram_collector_only.py
    
    - name: ðŸ“Š Generate Status Report
      run: |
        echo "ðŸ“Š Generating status report..."
        cat > subscriptions/bot_status.json << EOF
        {
          "bot_name": "onix",
          "bot_username": "@onixdev_bot",
          "bot_id": "8474552244",
          "admin_users": [6563143907],
          "status": "polling_active",
          "last_run": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "github_repo": "https://github.com/AhmadAkd/Onix-V2Ray-Collector",
          "polling_interval": "2_seconds",
          "collection_interval": "30_minutes",
          "commands": {
            "start": "Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø±Ø¨Ø§Øª",
            "help": "Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡",
            "stats": "Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…",
            "configs": "Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§",
            "admin": "Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ (ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†)"
          }
        }
        EOF
    
    - name: ðŸ“ Update README
      run: |
        echo "ðŸ“ Updating README with polling info..."
        cat >> README.md << 'EOF'
        
        ## ðŸ¤– Telegram Bot (Polling Mode)
        
        ### ðŸ“± **Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…**
        
        - **Ù†Ø§Ù…**: onix
        - **Username**: [@onixdev_bot](https://t.me/onixdev_bot)
        - **Bot ID**: 8474552244
        - **ÙˆØ¶Ø¹ÛŒØª**: âœ… ÙØ¹Ø§Ù„ Ø¨Ø§ Polling
        - **Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ**: âœ… Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
        
        ### ðŸ‘‘ **Ø§Ø¯Ù…ÛŒÙ†**
        
        - **User ID**: 6563143907
        - **Username**: @Deltamax
        - **Ù†Ø§Ù…**: samurai
        
        ### ðŸ“± **Ø¯Ø³ØªÙˆØ±Ø§Øª**
        
        | Ø¯Ø³ØªÙˆØ± | ØªÙˆØ¶ÛŒØ­ |
        |-------|-------|
        | `/start` | Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø±Ø¨Ø§Øª |
        | `/help` | Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ |
        | `/stats` | Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ… |
        | `/configs` | Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ |
        | `/admin` | Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ (ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†) |
        
        ### ðŸ”§ **Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§Ø¯Ù…ÛŒÙ†**
        
        | Ø¯Ø³ØªÙˆØ± | ØªÙˆØ¶ÛŒØ­ |
        |-------|-------|
        | `/admin` | Ù…Ù†ÙˆÛŒ Ø§Ø¯Ù…ÛŒÙ† |
        | `/admin stats` | Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ |
        | `/admin users` | Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† |
        | `/admin broadcast` | Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡ |
        
        ### ðŸ”„ **Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±**
        
        - **ÙØ§ØµÙ„Ù‡**: Ù‡Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
        - **Ù…Ù†Ø§Ø¨Ø¹**: Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…
        - **Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§**: VMess, VLESS, Trojan, SS, SSR, Hysteria
        - **Ú©Ø´ÙˆØ±Ù‡Ø§**: 25+ Ú©Ø´ÙˆØ±
        - **Ú¯Ø²Ø§Ø±Ø´**: Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
        
        EOF
    
    - name: ðŸ“¤ Commit and Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ðŸ¤– Update Telegram Bot status (Polling Mode)" || exit 0
        git push
